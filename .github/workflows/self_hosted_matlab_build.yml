name: MATLAB Build
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MATLAB_RELEASE: R2025b

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Resolve dependency file URL
        id: deps
        shell: bash
        run: |
          set -euo pipefail
          base="https://raw.githubusercontent.com/mathworks-ref-arch/container-images/main/matlab-deps"
          # Try these releases in order until one exists
          releases=("${MATLAB_RELEASE}" "R2025a" "R2024b" "R2024a")
          # Debian 12 may be named either of these in the repo
          systems=("debian-12" "debian/bookworm")
          for r in "${releases[@]}"; do
            for s in "${systems[@]}"; do
              url="${base}/${r}/${s}/base-dependencies.txt"
              if curl -fsI "$url" >/dev/null; then
                echo "url=${url}" >> "$GITHUB_OUTPUT"
                echo "release=${r}" >> "$GITHUB_OUTPUT"
                echo "system=${s}" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            done
          done
          echo "Could not find a dependency file for ${MATLAB_RELEASE} on Debian 12." >&2
          echo "Check available versions at: https://github.com/mathworks-ref-arch/container-images/tree/main/matlab-deps" >&2
          exit 1

      - name: Install MATLAB dependencies (Debian)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          curl -fsSL "${{ steps.deps.outputs.url }}" -o deps.txt
          grep -v -E '^\s*#|^\s*$' deps.txt | xargs -r sudo apt-get install -y --no-install-recommends
          sudo apt-get clean

      - name: Download MATLAB Package Manager (mpm)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://www.mathworks.com/mpm/glnxa64/mpm -o mpm
          chmod +x mpm
          ./mpm --version

      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: ${{ env.MATLAB_RELEASE }}
          cache: true

      - name: Run all tests
        uses: matlab-actions/run-tests@v2
        with:
          source-folder: code
          test-folder: tests
